# AIGC数字人

>这个项目是做什么的？项目背景是什么?

2023年是AIGC，也就是生成时AI集中爆发的一年，很多公司都投入到这个赛道并且布局了很多方向，我们公司其中有一个方向就是做`数字人`。用户上传自己的视频就能克隆一个数字人，输入文本就能得到数字人进行讲话的视频。这个项目的用户群里主要是`c端`的用户，所以我们也推出了微信小程序。

>项目技术栈&架构设计（如果自己作为项目的主力的话可以介绍下是在自己的参与下设计的架构）

项目技术栈主要使用的第三代微服务，也就k8s+单体服务的形式，后端主要使用`golang+grpc`进行开发，注册中心是`etcd`，数据库使用`mongoDB`，缓存使用`Redis`，消息队列使用的是`Kafka`。

项目主要分为三个大的模块，数字人视频生成模块，这个是我们的核心模块；订单管理模块，负责处理用户生成视频的订单和进行计量计费已经统计用量等功能；小程序和后台管理模块。

>项目中出现的难点

我们的核心模块数字人视频生成模块是一个典型的`io密集型场景`和计算密集型的场景

用户上传视频，需要维护大量的TCP连接，属于典型的`io密集型场景`。然后我们通过抖音直播的方式进行宣传，所以尽量不想让用户进行等待

- TCP连接过多：其中我们需要维持大量的用户的TCP连接，上传用户的视频，并且等待用户上传视频，这会导致连接可能会很多，刚开始我们投入的服务器并不多，在业务高峰时期，一台服务器可能得同时维护`1w`个TCP连接，我们内部也研究过这个问题并且把它称为`C10k`问题。在常见的`io密集型场景`常见中，一般需要产生大量的线程来处理，比如Tomcat服务器默认最大线程数就是`200个`、dubbo最大线程数也是`200个`。如果是短消息，像redis的这种，单线程就可以处理`10w`的TCP连接，因为他使用的是`事件循环机制`，也就是Linux底层提供epoll功能，但是如果redis出现大key，其实会堵塞线程，甚至导致redis崩溃
- 问题总结：
  - TCP连接过多，如果使用线程池容易把线程打满，一个线程默认
- 影响：很容易把CPU打满、内存打满
- 解决：首先我们服务器配置是32个核心128g内存的，然后是10g网口的，带宽上线大概能达到800MB/s；首先就是通过CDN也就是边缘节点缓存用户的视频，这个是七牛云本身就拥有的能力，通过k8s和普罗米修斯的参数，限制单个服务器的连接数，当服务器负载达到70%时，就会进行限流；然后使用golang轻量级的协程，因为golang内存占用比较小，一个线程栈空间才`4KB`，就算申请`1w`个协程，也才占用`40M`内存；使用事件循环机制，处理大量的并发连接，而不需要为每个连接创建一个线程。这样可以显著减少线程数和内存占用，类比到java中就算使用boss线程池和work线程池，boss线程池用来建立连接，work线程池用来处理任务；

用户输入文本合成视频，使用FFmpeg合成最后的视频，是一个CPU密集型场景

- 大量需要异步的操作，但是golang缺少异步编排的工具，比如java里面的`CompletableFuture`，所以我们写了一个`gofuture`来进行异步编排
- 在生成一个场景的的视频时，使用GPU进行加速