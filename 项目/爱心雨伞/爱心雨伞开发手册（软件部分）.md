# 爱心雨伞开发手册（软件部分）

技术栈：

```html
网页：vue2
UI：Element UI
后端：SpringBoot
数据库：mysql57
缓存：redis
文件系统管理：阿里云oss
服务器：Linux（centOS7）、内网穿透
微信小程序开发:原生开发（未用框架）
定时任务:xxx-job
文档：基于swagger3的knife4j
与锁机通信：基于UDP的Kcp协议
```

xxx-job管理后台：

```java
http://localhost:8081/xxl-job-admin/
userName:admin
password:123456
```

knife4j后台（接口文档）：

```css
http://localhost:8080/doc.html
账号：volunteer
密码：volunteer
```

数据库监视后台：

```css
http://localhost:8080/druid/login.html
账号：admin
密码：admin
```

修改前端请求服务器的地址需要修改这三个地方：

![image-20220304165346122](https://cdn.fengxianhub.top/resources-master/202203041653393.png)



启动项目

```css
npm run dev
```

打包项目

```css
npm run build:prod
```

![image-20220429154051434](https://cdn.fengxianhub.top/resources-master/202204291540663.png)



>由于个人开发者不能获取用户信息，所以需要找学校盖公章再在微信开发者里面联系腾讯的客服

微信小程序授权确认函格式如下：

```shell
正文如下所示：

鉴于：

【签约公司全名】欲向深圳市腾讯计算机系统有限公司及其关联机构（以下简称“腾讯”）申请通过微信小程序功能提供便民服务。

现【盖章主体】确认并授权：

【盖章主体】作为直接提供便民服务的法定主体，拥有做出本项授权的完整权力/权利。【签约公司全名】有权代表【盖章主体】向腾讯申请通过微信小程序功能提供便民服务（以下简称“该功能”），便民服务的具体内容为【服务具体内容】，并有权授权腾讯以实现并推广该功能为目的的使用【签约公司全名】通过微信小程序发布的服务信息及内容。

【盖章主体】已审查【签约公司全名】相关主体资格及能力，确认其有能力实施相关便民服务。被授权【签约公司全名】在本授权确认函授予的范围内与腾讯自行签订协议确定该功能的具体内容，由该功能及协议而造成【盖章主体】的责任，【签约公司全名】需要连带承担。

在该功能的操作、实现没有违法或超出本授权范围进行的前提下，【盖章主体】不对【签约公司全名】及腾讯就该功能提出对其双方不利的权利主张。

本函一式三份，【盖章主体】、【签约公司全名】和腾讯各持一份。

特此授权及确认！

 【盖章主体】联系方式（需公开可核实）：

                                                                                                                            盖章

                                                                                                                             二〇二一年  月
```

参考连接：<a href="https://www.jianshu.com/p/3ea87ef6e36d">**微信小程序授权确认函**</a>

## 第一部分：后台管理系统

### 1. 需求分析

```xml
能查看历史借阅记录
```





### 2. 数据库设计

详情见sql语句











## 第二部分：微信小程序

微信小程序的开发与前端开发很类似，如果读者有HTML、css、js和vue的基础一定能轻松驾驭

由于微信小程序的代码包不能超过1024k，所以里面的所有材料都放在云服务器了，笔者配置了两台云服务器和一台在学校的本地服务器，本来是想做负载均衡后面发现根本用不到（并发量太低，没什么优化的空间），本地服务器又不稳定，所以将后台管理系统和小程序接口及素材资源分别放在两台不同的云服务器了。

### 1.1  微信小程序静态资源设置



### 1.2  在微信小程序中获得相关信息

- 根据微信开发者手册规定，个人开发者只能获得用户的头像、昵称、和性别、openID（手机号需要base64解密，不方便，笔者没有实现，请读者自行实现）

- openID是微信提供给开发者用户的唯一凭证，可以用来作为用户身份的表示，通过usercode传到后台解密后可以得到openID

- 获得用户的头像昵称性别的json格式如下:(这里是笔者从缓存中取出的，data数据段不变)

  ![image-20211125210006504](https://cdn.fengxianhub.top/resources-master/202111252100160.png)











## 第三部分：服务器



### 1.内网穿透

#### 1.1 natapp内网穿透

​		这里采用的是natapp的内网穿透（有免费账号体验），配置文件都已经写好了，用java写了一个发邮件的程序（需短时间占用端口8080）

![image-20211116111604056](https://cdn.fengxianhub.top/resources-master/202111161116202.png)

​		这里发邮件是因为每次natapp启动的时候映射端口都会改变，如果想要管理，需要在你的shell中更换端口

![image-20211116111554721](https://cdn.fengxianhub.top/resources-master/202111161115903.png)



#### 1.2 设置natapp开机自启动

​		由于笔者采用的centOS7，和centOS6管理开机自启动服务有差异，这里采用的是systemctl管理服务，请读者自行查看相关内容





#### 1.3 frp结合阿里云内网穿透



## 第四部分：通信锁机定义帧

>所有的帧都是以H开头、T结尾，不遵守规范的帧都会被丢弃











## 附录：接口文档

注意：测试接口前请检查服务器是否正常运行

详情见knife4j接口文档





```css
  1:登陆用户接口
    请求地址:http://47.101.223.63/judgeUserInfo
    请求方法:get
    请求参数:userName(账户名),pwd(密码，采用sha256加密)
    响应内容:true表示有这个用户，false表示没有这个用户
	
  2:获取用户的userID
    请求地址:http://47.101.223.63/getUserCode
    请求方法:get
    请求参数:userCode(微信用户code，为随机字符串，在微信小程序中，每次用户登陆都不一样，但是Us)
    响应内容:返回用户的session_key和openid

......
```











