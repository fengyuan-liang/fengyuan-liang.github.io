# 						Redis中的多路复用的应用

#### 1、为什么说Redis是单线程的？

Redis 客户端对服务端的每次调用都经历了发送命令，执行命令，返回结果三个过程。其中执行命令阶段，由于 Redis 是单线程来处理命令的，所有到达服务端的命令都不会立刻执行，所有的命令都会进入一个队列中，然后逐个执行，并且多个客户端发送的命令的执行顺序是不确定的，但是可以确定的是不会有两条命令被同时执行，不会产生并发问题，这就是 Redis 的单线程基本模型。


![image-20220712204150397](Redis中的多路复用的应用/image-20220712204150397.png)

Redis 服务器通过 socket (套接字)与客户端或其他 Redis 服务器进行连接，而文件事件就是服务器对 socket 操作的抽象。服务器与客户端或其他服务器的通信会产生相应的文件事件，而服务器通过监听并处理这些事件来完成一系列网络通信操作。

Redis 基于 Reactor 模式开发了自己的网络事件处理器——文件事件处理器，文件事件处理器使用 I/O 多路复用程序来同时监听多个 socket，并根据 socket 目前执行的任务来为 socket 关联不同的事件处理器。当被监听的 socket 准备好执行连接应答、读取、写入、关闭等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用 socket 之前已关联好的事件处理器来处理这些事件。

- 文件事件处理器 使用 I/O多路复用（multiplexing）程序 来同时监听 多个套接字，并根据 套接字 目前执行的任务 来为 套接字 关联(动词) 不同的事件处理器
- 当被监听的套接字 准备好 执行 连接应答（accept）、读取（read）、写入（write）、关闭（close）等操作时，与 操作 相对应的 文件事件 就会产生，这时 文件事件处理器 就会调用 套接字之前关联好的事件处理器 来处理 这些事件
  ![image-20220712205356998](Redis中的多路复用的应用/image-20220712205356998.png)

#### 2、文件事件处理器的重要组成部分

套接字、I/O多路复用程序、文件事件分派器（dispatcher），以及事件处理器

I/O多路复用程序 负责监听 多个套接字，并向 文件事件分派器 传送 那些 产生了事件 的 套接字
尽管多个文件事件可能会并发地出现，但 I/O多路复用程序 总是会 将 所有 产生事件的套接字 都放到 一个队列里面，然后通过这个队列，以有序（sequentially）、同步（synchronously）、每次一个套接字的方式 向 文件事件分派器 传送 套接字。当上一个套接字产生的事件 被处理完毕之后（该套接字为事件所关联 的 事件处理器 执行完毕），I/O多路复用程序才会继续向文件事件分派器传送下一个套接字，如下图所示：

![image-20220712210358549](Redis中的多路复用的应用/image-20220712210358549.png)

#### 3、什么是Reactor模式？

1）Reactor模型，是基于事件驱动的，通过一个或多个输入同时传递给服务端处理

2）服务端程序处理传入的多个请求，并分发到相应的处理线程

3）基于I/O多路复用模型：多个连接共用一个阻塞对象，应用程序只需在一个阻塞对象等待，无需阻塞等待所有连接。当某个连接有新的数据可以处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理

4）基于线程池复用线程资源：不必为每个连接创建线程，将连接完成后的业务处理任务分配给线程池进行处理，一个线程可以处理多个连接的业务

##### 一、单Reactor单线程

1）可以实现通过一个阻塞对象监听多个链接请求

2）Reactor对象通过select监听客户端请求事件，通过dispatch进行分发

3）如果是建立链接请求，则由Acceptor通过accept处理链接请求，然后创建一个Handler对象处理完成链接后的各种事件

4）如果不是链接请求，则由Reactor分发调用链接对应的Handler来处理

5）Handler会完成Read->业务处理->send的完整业务流程

![image-20220712204743430](Redis中的多路复用的应用/image-20220712204743430.png)

##### 二、单Reactor多线程

1）Reactor对象通过select监听客户端请求事件，收到事件后，通过dispatch分发

2）如果是建立链接请求，则由Acceptor通过accept处理链接请求，然后创建一个Handler对象处理完成链接后的各种事件

3）如果不是链接请求，则由Reactor分发调用链接对应的Handler来处理

4）Handler只负责事件响应不做具体业务处理

5）通过read读取数据后，分发到worker线程池处理，处理完成后返回给Handler，Handler收到后，通过send将结果返回给client

![image-20220712204810949](Redis中的多路复用的应用/image-20220712204810949.png)

##### 三、主从Reactor多线程

1）Reactor主线程MainReactor对象通过select监听链接事件，通过Acceptor处理

2）当Acceptor处理链接事件后，MainReactor将链接分配给SubReactor

3）SubReactor将链接加入到队列进行监听，并创建Handler进行事件处理

4）当有新事件发生时，SubReactor就会调用对应的Handler处理

5）Handler通过read读取数据，分发到worker线程池处理，处理完成后返回给Handler，Handler收到后，通过send将结果返回给client

6）Reactor主线程可以对应多个Reactor子线程

![image-20220712204827558](Redis中的多路复用的应用/image-20220712204827558.png)

##### 四、总结

三种模式用生活案例来理解

1）单Reactor单线程，前台接待员和服务员是同一个人，全程为顾客服务

2）单Reactor多线程，1个前台接待员，多个服务员，接待员只负责接待

3）主从Reactor多线程，多个前台接待员，多个服务员

Reactor模型具有如下优点：

1）响应快，不必为单个同步事件所阻塞，虽然Reactor本身依然是同步的

2）可以最大程度的避免复杂的多线程及同步问题，并且避免了多线程/进程的切换开销

3）扩展性好，可以方便的通过增加Reactor实例个数来充分利用CPU资源

4）复用性好，Reactor模型本身与具体事件处理逻辑无关，具有很高的复用性

多路复用的链接：https://blog.csdn.net/weixin_38405646/article/details/120549379

